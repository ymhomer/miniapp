<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Jianpu Editor</title>
  <style>
    /* Global style */
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #f7f7f7;
    }
    /* Top Toolbar */
    #toolbar {
      background-color: #3a3a3a;
      color: #fff;
      padding: 8px 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    #toolbar button {
      background-color: #555;
      color: #fff;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 6px;
      transition: background-color 0.2s;
    }
    #toolbar button:hover {
      background-color: #777;
    }
    #toolbar label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.9em;
    }
    #toolbar input[type=number],
    #toolbar select {
      padding: 2px 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    /* Reset button */
    #toolbar button.reset-btn {
      background-color: #d9534f;
    }
    #toolbar button.reset-btn:hover {
      background-color: #c9302c;
    }
    /* Score Library toggle button */
    #toolbar button#toggle-library-btn {
      background-color: #007bff;
    }
    #toolbar button#toggle-library-btn:hover {
      background-color: #0056b3;
    }
    /* Help button */
    #toolbar button#help-btn {
      background-color: #28a745;
    }
    #toolbar button#help-btn:hover {
      background-color: #218838;
    }
    /* Help Modal */
    #helpModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    #helpModal .modal-content {
      background-color: #fff;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      position: relative;
    }
    #helpModal .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    #helpModal .modal-header h5 {
      margin: 0;
      font-size: 1.2em;
      color: #333;
    }
    #helpModal .modal-close {
      background-color: #555;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #helpModal .modal-close:hover {
      background-color: #777;
    }
    #helpModal .modal-body {
      max-height: 60vh;
      overflow-y: auto;
      color: #333;
      font-size: 0.95em;
    }
    #helpModal .modal-body h6 {
      margin-top: 15px;
      font-size: 1em;
      color: #3a3a3a;
    }
    #helpModal .modal-body p, #helpModal .modal-body ul {
      margin: 10px 0;
    }
    #helpModal .modal-body ul {
      padding-left: 20px;
    }
    #helpModal .modal-body li {
      margin-bottom: 5px;
    }
    /* Score Library panel */
    #library-panel {
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      max-height: 250px;
      overflow-y: auto;
      margin: 10px;
      display: none;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    #library-panel h3 {
      margin: 0 0 6px 0;
      font-size: 1.1em;
    }
    #library-panel #library-actions {
      margin-bottom: 8px;
    }
    #library-panel #library-actions button {
      margin-right: 8px;
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.15s;
    }
    #library-panel #library-actions button#import-btn {
      background-color: #28a745;
      color: #fff;
    }
    #library-panel #library-actions button#export-btn {
      background-color: #17a2b8;
      color: #fff;
    }
    #library-panel #library-actions button:hover {
      opacity: 0.9;
    }
    #library-panel ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #library-panel li {
      padding: 4px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px dashed #ccc;
    }
    #library-panel li:last-child {
      border-bottom: none;
    }
    #library-panel li button {
      font-size: 0.85em;
      padding: 2px 6px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #library-panel li button.load-btn {
      background-color: #007bff;
      color: #fff;
    }
    #library-panel li button.delete-btn {
      background-color: #d9534f;
      color: #fff;
    }
    #library-panel button#close-library-btn {
      margin-top: 8px;
      background-color: #007bff;
      color: #fff;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    /* Editor Area */
    #editor-area {
      flex-grow: 1;
      overflow-y: auto;
      padding: 12px;
      background-color: #fff;
      border: 1px solid #ddd;
      margin: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      position: relative;
    }
    #score-content {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .measure {
      display: flex;
      flex-direction: column;
      border: 1px solid #aaa;
      padding: 8px;
      min-height: 80px;
      min-width: 150px;
      background-color: #fff;
      box-sizing: border-box;
      border-radius: 6px;
    }
    .measure-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.8em;
      color: #555;
      margin-bottom: 6px;
    }
    .time-signature { font-weight: bold; }
    .beat-info { color: #888; }
    .beat-info.error { color: #d9534f; font-weight: bold; }
    .notes-container {
      flex-grow: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      gap: 4px;
    }
    .note, .rest {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      padding: 4px 6px;
      border: 1px solid transparent;
      border-radius: 4px;
      min-width: 1em;
      text-align: center;
      font-size: 1.2em;
      transition: background-color 0.15s;
      cursor: pointer;
      position: relative;
    }
    .note:hover, .rest:hover { background-color: #f0f0f0; }
    .note.selected, .rest.selected { border: 1px solid #007bff; background-color: #e7f1ff; }
    .note .pitch-container {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .note .pitch { font-weight: bold; }
    .note .octave-dot-above,
    .note .octave-dot-below {
      display: block;
      font-size: 0.8em;
      line-height: 1;
      width: 100%;
      text-align: center;
    }
    .note .octave-dot-above { margin-bottom: 2px; }
    .note .octave-dot-below { margin-top: 2px; }
    .note .accidental { font-size: 0.9em; margin-right: 2px; }
    .note .dot, .note .tie-char { font-weight: bold; margin-left: 2px; }
    .note .duration-char {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 1px;
    }
    .note .duration-char span {
      font-size: 0.6em;
      line-height: 0.7;
      color: #d9534f;
      opacity: 0.9;
      margin: 0;
      padding: 0;
      text-shadow: 0 0 1px rgba(0,0,0,0.1);
    }
    .note .duration-char span:not(:first-child) {
      transform: translateY(-1px);
    }
    .rest { color: #666; font-weight: bold; }
    .rest .pitch-container { display: flexanium; align-items: center; }
    .rest .dot { font-weight: bold; margin-left: 2px; }
    .rest .duration-char {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 1px;
    }
    .rest .duration-char span {
      font-size: 0.6em;
      line-height: 0.7;
      color: #d9534f;
      opacity: 0.9;
      margin: 0;
      padding: 0;
      text-shadow: 0 0 1px rgba(0,0,0,0.1);
    }
    .rest .duration-char span:not(:first-child) {
      transform: translateY(-1px);
    }
    /* Cursor */
    #cursor {
      display: inline-block;
      width: 2px;
      height: 1.5em;
      background-color: #333;
      position: absolute;
      pointer-events: none;
      animation: blink 1s step-end infinite;
    }
    @keyframes blink { 50% { opacity: 0; } }
    /* Bottom Action Bar */
    #action-bar {
      background-color: #f2f2f2;
      padding: 8px 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      flex-shrink: 0;
      border-top: 1px solid #ddd;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
    }
    #action-bar button {
      padding: 6px 10px;
      font-size: 1em;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background-color: #fff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
      transition: background-color 0.15s;
    }
    #action-bar button:active { background-color: #e6e6e6; }
    .action-group {
      display: flex;
      gap: 6px;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background-color: #fafafa;
    }
    .action-group span {
      align-self: center;
      font-size: 0.9em;
    }
    /* Responsive: small screens */
    @media (max-width: 600px) {
      #toolbar { flex-direction: column; align-items: stretch; }
      #action-bar { flex-direction: column; }
      #editor-area { margin: 6px; padding: 6px; }
      .measure { min-width: 100px; padding: 4px; }
      .action-group { flex-wrap: wrap; }
      #helpModal .modal-content { width: 95%; }
    }
  </style>
</head>
<body>

  <!-- Top Toolbar -->
  <div id="toolbar">
    <button id="play-btn">Play</button>
    <button id="toggle-library-btn">Show Score Library</button>
    <button class="reset-btn" id="reset-btn">Reset</button>
    <button id="help-btn">Help</button>
    <label>
      Time Sig:
      <input type="number" id="time-sig-beats" value="4" min="1">
      /
      <select id="time-sig-beat-type">
        <option value="4">4</option>
        <option value="8">8</option>
        <option value="2">2</option>
      </select>
    </label>
    <label>
      BPM:
      <input type="number" id="bpm-input" value="120" min="30" max="300">
    </label>
  </div>

  <!-- Help Modal -->
  <div id="helpModal">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Jianpu Editor Help</h5>
        <button class="modal-close">Close</button>
      </div>
      <div class="modal-body">
        <h6>Overview</h6>
        <p>This editor allows you to create and edit Jianpu (numbered musical notation) scores. Use the toolbar to play, reset, or manage scores, and the bottom action bar to input notes, rests, and modifications.</p>
        <h6>Key Mappings</h6>
        <ul>
          <li><strong>1–7</strong>: Insert a note (1=Do, 2=Re, ..., 7=Ti)</li>
          <li><strong>0</strong>: Insert a rest</li>
          <li><strong>Backspace/Delete</strong>: Delete the note before the cursor</li>
          <li><strong>Arrow Left/Right</strong>: Move cursor between notes or measures</li>
          <li><strong>Arrow Up/Down</strong>: Increase/decrease octave (when a note is selected)</li>
          <li><strong>#</strong>: Add sharp to selected note</li>
          <li><strong>b</strong>: Add flat to selected note</li>
          <li><strong>.</strong>: Toggle dotted note (extends duration by 1.5x)</li>
          <li><strong>-</strong>: Add tie to selected note (extends duration)</li>
          <li><strong>_</strong>: Shorten duration (e.g., quarter to eighth, up to 32nd note)</li>
          <li><strong>Enter</strong>: Add a new measure</li>
        </ul>
        <h6>Usage Tips</h6>
        <ul>
          <li>Click a note to select it, then use the action bar or keys to modify it.</li>
          <li>Use underscores (_) to shorten note duration, compactly stacked vertically below the note (e.g., three _ for a 32nd note).</li>
          <li>Use dashes (-) for ties, appearing after the note (e.g., 1-).</li>
          <li>Monitor the beat info in each measure to ensure correct timing.</li>
          <li>Use the Score Library to import/export scores as JSON files.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Score Library Panel -->
  <div id="library-panel">
    <h3>Score Library</h3>
    <div id="library-actions">
      <button id="library-import-btn" title="Import Scores">Import Scores</button>
      <button id="library-export-btn" title="Export Current Score">Export Current Score</button>
    </div>
    <ul id="library-list"></ul>
    <button id="close-library-btn">Close Library</button>
  </div>

  <!-- Editor Area -->
  <div id="editor-area">
    <div id="score-content"></div>
    <span id="cursor" style="left: 10px;"></span>
  </div>

  <!-- Bottom Action Bar -->
  <div id="action-bar">
    <div class="action-group">
      <span>Notes:</span>
      <button data-value="1">1</button>
      <button data-value="2">2</button>
      <button data-value="3">3</button>
      <button data-value="4">4</button>
      <button data-value="5">5</button>
      <button data-value="6">6</button>
      <button data-value="7">7</button>
      <button data-value="0">0 (Rest)</button>
    </div>
    <div class="action-group">
      <span>Accid:</span>
      <button data-value="#">#</button>
      <button data-value="b">b</button>
      <button data-value="clear-accid">Clear</button>
    </div>
    <div class="action-group">
      <span>Octave:</span>
      <button data-value="octave-up">↑ (·)</button>
      <button data-value="octave-down">↓ (.)</button>
      <button data-value="octave-clear">Clear</button>
    </div>
    <div class="action-group">
      <span>Duration:</span>
      <button data-value="dot">Dot (.)</button>
      <button data-value="tie">Tie (-)</button>
      <button data-value="shorten">Shorten (_)</button>
    </div>
    <div class="action-group">
      <span>Edit:</span>
      <button data-value="delete">Delete</button>
      <button data-value="add-note-cursor">Add Note</button>
    </div>
  </div>

  <!-- Hidden file input -->
  <input type="file" id="import-file" class="hidden" accept=".json, .txt" multiple style="display: none;">

  <script>
    /* Basic Web Audio functions */
    let audioCtx;
    function initAudio() {
      if (!audioCtx) {
        try {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          console.error("Web Audio API not supported");
          alert("Web Audio API is not supported, playback disabled.");
        }
      }
    }
    function playTone(pitchVal, octave, durationSeconds, startTime) {
      if (!audioCtx) return;
      const noteFrequencies = { 1: 261.63, 2: 293.66, 3: 329.63, 4: 349.23, 5: 392.00, 6: 440.00, 7: 493.88 };
      let baseFreq = noteFrequencies[pitchVal];
      if (!baseFreq) return;
      let freq = baseFreq * Math.pow(2, octave);
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(freq, startTime);
      gainNode.gain.setValueAtTime(0.5, startTime);
      gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + durationSeconds);
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      oscillator.start(startTime);
      oscillator.stop(startTime + durationSeconds);
    }
    function playFeedback(noteElement) {
      initAudio();
      const pitch = parseInt(noteElement?.dataset.pitch || '1');
      const octave = parseInt(noteElement?.dataset.octave || '0');
      if (pitch > 0) {
        playTone(pitch, octave, 0.3, audioCtx.currentTime);
      }
    }
  </script>

  <script>
    // DOM elements
    const editorArea = document.getElementById('editor-area');
    const scoreContent = document.getElementById('score-content');
    const actionBar = document.getElementById('action-bar');
    const cursor = document.getElementById('cursor');
    const timeSigBeatsInput = document.getElementById('time-sig-beats');
    const timeSigBeatTypeSelect = document.getElementById('time-sig-beat-type');
    const bpmInput = document.getElementById('bpm-input');
    const playBtn = document.getElementById('play-btn');
    const importFileEl = document.getElementById('import-file');
    const libraryPanel = document.getElementById('library-panel');
    const libraryList = document.getElementById('library-list');
    const toggleLibraryBtn = document.getElementById('toggle-library-btn');
    const closeLibraryBtn = document.getElementById('close-library-btn');
    const resetBtn = document.getElementById('reset-btn');
    const libraryImportBtn = document.getElementById('library-import-btn');
    const libraryExportBtn = document.getElementById('library-export-btn');
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('helpModal');
    const helpModalClose = helpModal.querySelector('.modal-close');

    // Global state
    let score = {
      timeSignature: { beats: 4, beatType: 4 },
      bpm: 120,
      measures: []
    };
    let scoreLibrary = [];
    let cursorPosition = { measureIndex: 0, noteIndex: 0 };
    let selectedElement = null;
    let nextId = 0;

    function getNewId() { return `elem-${nextId++}`; }
    function getBeatValue(beatType) { return 4 / beatType; }

    function calculateMeasureBeats(measureIndex) {
      if (!score.measures[measureIndex]) return 0;
      let totalBeats = 0;
      const beatValue = getBeatValue(score.timeSignature.beatType);
      score.measures[measureIndex].notes.forEach(note => {
        let duration = note.durationBase * beatValue;
        if (note.dotted) duration *= 1.5;
        if (note.tieCount > 0) duration += note.durationBase * note.tieCount * beatValue;
        totalBeats += duration;
      });
      return totalBeats;
    }

    // Render note element
    function renderNoteElement(noteData) {
      const noteEl = document.createElement('span');
      noteEl.id = noteData.id;
      noteEl.dataset.measureIndex = cursorPosition.measureIndex;
      noteEl.dataset.noteId = noteData.id;
      noteEl.tabIndex = 0;
      Object.keys(noteData).forEach(key => {
        if (typeof noteData[key] !== 'object') noteEl.dataset[key] = noteData[key];
      });
      if (noteData.type === 'note') {
        noteEl.className = 'note';
        let content = '<span class="pitch-container">';
        if (noteData.octave > 0) content += `<span class="octave-dot-above">${'·'.repeat(noteData.octave)}</span>`;
        if (noteData.accidental) content += `<span class="accidental">${noteData.accidental}</span>`;
        content += `<span class="pitch">${noteData.pitch}</span>`;
        if (noteData.dotted) content += `<span class="dot">.</span>`;
        if (noteData.tieCount > 0) content += `<span class="tie-char">${'-'.repeat(noteData.tieCount)}</span>`;
        if (noteData.octave < 0) content += `<span class="octave-dot-below">${'·'.repeat(Math.abs(noteData.octave))}</span>`;
        content += '</span>';
        if (noteData.durationBase < 1) {
          const underscoreCount = Math.log2(1 / noteData.durationBase);
          content += '<span class="duration-char">';
          for (let i = 0; i < underscoreCount; i++) content += '<span>_</span>';
          content += '</span>';
        }
        noteEl.innerHTML = content;
      } else if (noteData.type === 'rest') {
        noteEl.className = 'rest';
        let content = '<span class="pitch-container">0';
        if (noteData.dotted) content += `<span class="dot">.</span>`;
        content += '</span>';
        if (noteData.durationBase < 1) {
          const underscoreCount = Math.log2(1 / noteData.durationBase);
          content += '<span class="duration-char">';
          for (let i = 0; i < underscoreCount; i++) content += '<span>_</span>';
          content += '</span>';
        }
        noteEl.innerHTML = content;
      }
      noteEl.addEventListener('click', (event) => {
        event.stopPropagation();
        selectElement(noteEl);
        const noteIndex = score.measures[noteEl.dataset.measureIndex].notes.findIndex(n => n.id === noteData.id);
        moveCursorTo(parseInt(noteEl.dataset.measureIndex), noteIndex);
        playFeedback(noteEl);
      });
      let pressTimer;
      noteEl.addEventListener('touchstart', (e) => {
        pressTimer = setTimeout(() => selectElement(noteEl), 800);
      });
      noteEl.addEventListener('touchend', () => clearTimeout(pressTimer));
      noteEl.addEventListener('touchmove', () => clearTimeout(pressTimer));
      noteEl.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        selectElement(noteEl);
      });
      return noteEl;
    }

    function renderMeasure(measureData, measureIndex) {
      const measureEl = document.createElement('div');
      measureEl.className = 'measure';
      measureEl.id = measureData.id;
      measureEl.dataset.measureIndex = measureIndex;
      const headerEl = document.createElement('div');
      headerEl.className = 'measure-header';
      const timeSigEl = document.createElement('span');
      timeSigEl.className = 'time-signature';
      if (measureIndex === 0) timeSigEl.textContent = `${score.timeSignature.beats}/${score.timeSignature.beatType}`;
      const beatInfoEl = document.createElement('span');
      beatInfoEl.className = 'beat-info';
      headerEl.appendChild(timeSigEl);
      headerEl.appendChild(beatInfoEl);
      measureEl.appendChild(headerEl);
      const notesContainer = document.createElement('div');
      notesContainer.className = 'notes-container';
      measureData.notes.forEach(noteData => {
        notesContainer.appendChild(renderNoteElement(noteData));
      });
      measureEl.appendChild(notesContainer);
      measureEl.addEventListener('click', (event) => {
        if (event.target === measureEl || event.target === notesContainer) {
          const mIndex = parseInt(measureEl.dataset.measureIndex);
          const noteCount = score.measures[mIndex].notes.length;
          moveCursorTo(mIndex, noteCount);
          deselectElement();
        }
      });
      updateMeasureBeatInfo(measureEl, measureIndex);
      return measureEl;
    }

    function updateMeasureBeatInfo(measureElement, measureIndex) {
      const beatInfoEl = measureElement.querySelector('.beat-info');
      if (!beatInfoEl) return;
      const currentBeats = calculateMeasureBeats(measureIndex);
      const targetBeats = score.timeSignature.beats;
      beatInfoEl.textContent = `${currentBeats.toFixed(2)} / ${targetBeats}`;
      if (Math.abs(currentBeats - targetBeats) > 0.01) beatInfoEl.classList.add('error');
      else beatInfoEl.classList.remove('error');
    }

    function renderScore() {
      scoreContent.innerHTML = '';
      score.measures.forEach((measureData, index) => {
        scoreContent.appendChild(renderMeasure(measureData, index));
      });
      updateCursorPosition();
    }

    // Cursor management
    function moveCursorTo(measureIndex, noteIndex) {
      measureIndex = Math.max(0, Math.min(measureIndex, score.measures.length - 1));
      if (score.measures.length === 0) {
        measureIndex = -1;
        noteIndex = 0;
      } else if (measureIndex >= 0) {
        noteIndex = Math.max(0, Math.min(noteIndex, score.measures[measureIndex].notes.length));
      }
      cursorPosition.measureIndex = measureIndex;
      cursorPosition.noteIndex = noteIndex;
      updateCursorPosition();
      deselectElement();
    }

    function updateCursorPosition() {
      if (cursorPosition.measureIndex < 0 || score.measures.length === 0) {
        cursor.style.left = `10px`;
        cursor.style.top = `25px`;
        cursor.style.display = 'inline-block';
        return;
      }
      const measureElement = scoreContent.children[cursorPosition.measureIndex];
      if (!measureElement) {
        cursor.style.display = 'none';
        return;
      }
      const notesContainer = measureElement.querySelector('.notes-container');
      if (!notesContainer) {
        cursor.style.display = 'none';
        return;
      }
      let targetElement;
      if (cursorPosition.noteIndex < notesContainer.children.length) {
        targetElement = notesContainer.children[cursorPosition.noteIndex];
      } else {
        targetElement = notesContainer.children[notesContainer.children.length - 1] || notesContainer;
      }
      if (targetElement) {
        const rect = targetElement.getBoundingClientRect();
        const containerRect = scoreContent.getBoundingClientRect();
        let left = rect.left - containerRect.left + editorArea.scrollLeft;
        if (cursorPosition.noteIndex >= notesContainer.children.length) {
          left += rect.width;
        }
        let top = rect.top - containerRect.top + (rect.height / 2) - (cursor.offsetHeight / 2) + 5;
        cursor.style.left = `${left}px`;
        cursor.style.top = `${top}px`;
        cursor.style.display = 'inline-block';
      } else {
        cursor.style.display = 'none';
      }
    }

    // Selection management
    function selectElement(element) {
      deselectElement();
      if (element) {
        selectedElement = element;
        selectedElement.classList.add('selected');
        selectedElement.focus();
      }
    }

    function deselectElement() {
      if (selectedElement) {
        selectedElement.classList.remove('selected');
        selectedElement.blur();
      }
      selectedElement = null;
    }

    function getNoteDataFromElement(element) {
      if (!element || !element.dataset || !element.dataset.noteId) return null;
      const measureIndex = parseInt(element.dataset.measureIndex);
      const noteId = element.dataset.noteId;
      if (isNaN(measureIndex) || !noteId || !score.measures[measureIndex]) return null;
      return score.measures[measureIndex].notes.find(n => n.id === noteId);
    }

    // Insert note
    function insertNote(noteData) {
      if (calculateMeasureBeats(cursorPosition.measureIndex) >= score.timeSignature.beats - 0.001) {
        addMeasure();
      }
      const measure = score.measures[cursorPosition.measureIndex];
      if (!measure) return;
      const fullNoteData = {
        id: getNewId(),
        type: 'note',
        pitch: 1,
        octave: 0,
        durationBase: 1,
        tieCount: 0,
        accidental: null,
        dotted: false,
        ...noteData
      };
      measure.notes.splice(cursorPosition.noteIndex, 0, fullNoteData);
      cursorPosition.noteIndex++;
      renderScore();
      const newElement = document.getElementById(fullNoteData.id);
      if (newElement) {
        selectElement(newElement);
        playFeedback(newElement);
      }
    }

    // Delete
    function deleteNoteAtCursor() {
      if (cursorPosition.measureIndex < 0 || score.measures.length === 0) return;
      const measure = score.measures[cursorPosition.measureIndex];
      if (!measure) return;
      if (measure.notes.length === 0) {
        if (score.measures.length > 1) {
          score.measures.splice(cursorPosition.measureIndex, 1);
          cursorPosition.measureIndex = Math.max(0, cursorPosition.measureIndex - 1);
          cursorPosition.noteIndex = score.measures[cursorPosition.measureIndex].notes.length;
          renderScore();
          return;
        }
        return;
      }
      let deleteIndex = -1;
      if (selectedElement) {
        const selectedData = getNoteDataFromElement(selectedElement);
        if (selectedData) deleteIndex = measure.notes.findIndex(n => n.id === selectedData.id);
      }
      if (deleteIndex === -1 && cursorPosition.noteIndex > 0) deleteIndex = cursorPosition.noteIndex - 1;
      if (deleteIndex !== -1) {
        measure.notes.splice(deleteIndex, 1);
        cursorPosition.noteIndex = Math.max(0, deleteIndex);
        renderScore();
      }
      deselectElement();
    }

    function deleteNoteAtElement(element) {
      const data = getNoteDataFromElement(element);
      if (!data) return;
      const measureIndex = parseInt(element.dataset.measureIndex);
      const measure = score.measures[measureIndex];
      const noteIndex = measure.notes.findIndex(n => n.id === data.id);
      if (noteIndex !== -1) {
        measure.notes.splice(noteIndex, 1);
        if (cursorPosition.measureIndex === measureIndex && cursorPosition.noteIndex > noteIndex) {
          cursorPosition.noteIndex--;
        }
        renderScore();
        deselectElement();
      }
    }

    // Modify selected note
    function modifySelectedNote(property, value) {
      if (!selectedElement) return;
      const data = getNoteDataFromElement(selectedElement);
      if (!data) return;
      const measureIndex = parseInt(selectedElement.dataset.measureIndex);
      const measure = score.measures[measureIndex];
      let needsRender = true;
      switch (property) {
        case 'pitch':
          if (data.type === 'note') data.pitch = parseInt(value);
          break;
        case 'type':
          data.type = value;
          if (value === 'rest') {
            data.pitch = 0;
            data.octave = 0;
            data.accidental = null;
            data.tieCount = 0;
          } else {
            data.pitch = data.pitch || 1;
          }
          break;
        case 'accidental':
          if (data.type === 'note') {
            if (value === '#' && (data.pitch === 3 || data.pitch === 7)) {
              console.warn("Cannot raise E(3) or B(7)");
              return;
            }
            data.accidental = (data.accidental === value) ? null : value;
          }
          break;
        case 'octave':
          if (data.type === 'note') {
            if (value === '+1') data.octave++;
            else if (value === '-1') data.octave--;
            else if (value === 'clear') data.octave = 0;
            data.octave = Math.max(-2, Math.min(2, data.octave));
          }
          break;
        case 'shorten':
          if (data.type === 'rest' || data.type === 'note') {
            data.durationBase = Math.max(0.125, data.durationBase / 2);
            if (data.type === 'rest') data.tieCount = 0;
          }
          break;
        case 'tie':
          if (data.type === 'note') data.tieCount++;
          else {
            console.warn("Cannot apply tie '-' to rests");
            return;
          }
          break;
        case 'dotted':
          if (data.type === 'rest' || data.type === 'note') data.dotted = !data.dotted;
          else {
            console.warn("Cannot dot this element type");
            return;
          }
          break;
        default:
          needsRender = false;
      }
      if (needsRender) {
        renderScore();
        const reselected = document.getElementById(data.id);
        if (reselected) selectElement(reselected);
        playFeedback(selectedElement);
      }
    }

    // Add a new measure
    function addMeasure() {
      const newMeasure = { id: getNewId(), notes: [] };
      score.measures.push(newMeasure);
      cursorPosition.measureIndex = score.measures.length - 1;
      cursorPosition.noteIndex = 0;
      renderScore();
    }

    // Reset the editor
    function resetEditor() {
      if (confirm("Are you sure you want to reset the editor? All content will be lost.")) {
        score = { timeSignature: { beats: 4, beatType: 4 }, bpm: 120, measures: [] };
        nextId = 0;
        addMeasure();
        moveCursorTo(0, 0);
      }
    }

    // Event listeners for bottom action bar and keyboard
    actionBar.addEventListener('click', (event) => {
      if (event.target.tagName === 'BUTTON') {
        const action = event.target.dataset.value;
        initAudio();
        if (!action) return;
        if (['1','2','3','4','5','6','7'].includes(action)) {
          insertNote({ type: 'note', pitch: parseInt(action) });
        } else if (action === '0') {
          insertNote({ type: 'rest', pitch: 0 });
        } else if (action === 'add-note-cursor') {
          insertNote({ type: 'note', pitch: 1 });
        } else if (action === 'delete') {
          deleteNoteAtCursor();
        } else if (selectedElement) {
          if (action === '#') modifySelectedNote('accidental', '#');
          else if (action === 'b') modifySelectedNote('accidental', 'b');
          else if (action === 'clear-accid') modifySelectedNote('accidental', null);
          else if (action === 'octave-up') modifySelectedNote('octave', '+1');
          else if (action === 'octave-down') modifySelectedNote('octave', '-1');
          else if (action === 'octave-clear') modifySelectedNote('octave', 'clear');
          else if (action === 'dot') modifySelectedNote('dotted', true);
          else if (action === 'tie') modifySelectedNote('tie', true);
          else if (action === 'shorten') modifySelectedNote('shorten', true);
        } else {
          console.log("Select a note first for this action:", action);
        }
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT' || event.target.tagName === 'TEXTAREA') return;
      initAudio();
      const key = event.key;
      let handled = true;
      if (key >= '1' && key <= '7') {
        insertNote({ type: 'note', pitch: parseInt(key) });
      } else if (key === '0') {
        insertNote({ type: 'rest', pitch: 0 });
      } else if (key === 'Backspace' || key === 'Delete') {
        deleteNoteAtCursor();
      } else if (key === 'ArrowLeft') {
        if (cursorPosition.noteIndex > 0) {
          moveCursorTo(cursorPosition.measureIndex, cursorPosition.noteIndex - 1);
        } else if (cursorPosition.measureIndex > 0) {
          const prevMeasureIndex = cursorPosition.measureIndex - 1;
          moveCursorTo(prevMeasureIndex, score.measures[prevMeasureIndex].notes.length);
        }
      } else if (key === 'ArrowRight') {
        const currentMeasure = score.measures[cursorPosition.measureIndex];
        if (!currentMeasure) return;
        if (cursorPosition.noteIndex < currentMeasure.notes.length) {
          moveCursorTo(cursorPosition.measureIndex, cursorPosition.noteIndex + 1);
        } else if (cursorPosition.measureIndex < score.measures.length - 1) {
          moveCursorTo(cursorPosition.measureIndex + 1, 0);
        }
      } else if (key === 'ArrowUp' && selectedElement) {
        modifySelectedNote('octave', '+1');
      } else if (key === 'ArrowDown' && selectedElement) {
        modifySelectedNote('octave', '-1');
      } else if (key === '#' && selectedElement) {
        modifySelectedNote('accidental', '#');
      } else if (key === 'b' && selectedElement) {
        modifySelectedNote('accidental', 'b');
      } else if (key === '.' && selectedElement) {
        modifySelectedNote('dotted', true);
      } else if (key === '-' && selectedElement) {
        modifySelectedNote('tie', true);
      } else if (key === '_' && selectedElement) {
        modifySelectedNote('shorten', true);
      } else if (key === 'Enter') {
        addMeasure();
      } else {
        handled = false;
      }
      if (handled) event.preventDefault();
    });

    // Reset button
    resetBtn.addEventListener('click', resetEditor);

    // Help modal
    helpBtn.addEventListener('click', () => {
      helpModal.style.display = 'flex';
    });
    helpModalClose.addEventListener('click', () => {
      helpModal.style.display = 'none';
    });
    helpModal.addEventListener('click', (e) => {
      if (e.target === helpModal) helpModal.style.display = 'none';
    });

    // Score Library Panel Functions
    function generateScoreDataForExport() {
      return JSON.parse(JSON.stringify(score));
    }

    // Export the current score as JSON
    libraryExportBtn.addEventListener('click', () => {
      const scoreData = generateScoreDataForExport();
      const jsonString = JSON.stringify(scoreData, null, 2);
      let fileName = prompt("Please enter file name for export (without extension):", "jianpu_score");
      if (!fileName) fileName = "jianpu_score";
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Import Scores
    libraryImportBtn.addEventListener('click', () => {
      importFileEl.click();
    });

    // Handle file input change for importing multiple files
    importFileEl.addEventListener('change', (event) => {
      const files = event.target.files;
      if (!files || files.length === 0) return;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const importedData = JSON.parse(e.target.result);
            if (importedData && importedData.timeSignature && importedData.measures) {
              scoreLibrary.push({ name: file.name, data: importedData });
              updateLibraryList();
            } else {
              alert(`File "${file.name}" is not a valid score format.`);
            }
          } catch (err) {
            console.error("Error parsing JSON file:", err);
            alert(`Error loading file "${file.name}": ${err.message}`);
          }
        };
        reader.onerror = (err) => {
          console.error("File reading error:", err);
          alert(`Error reading file "${file.name}".`);
        };
        reader.readAsText(file);
      }
      event.target.value = "";
    });

    // Update the library list UI
    function updateLibraryList() {
      libraryList.innerHTML = "";
      scoreLibrary.forEach((item, index) => {
        const li = document.createElement('li');
        li.textContent = item.name;
        const loadBtn = document.createElement('button');
        loadBtn.textContent = "Load Score";
        loadBtn.className = "load-btn";
        loadBtn.addEventListener('click', () => {
          nextId = 0;
          item.data.measures.forEach(measure => {
            measure.id = getNewId();
            measure.notes.forEach(note => note.id = getNewId());
          });
          score = JSON.parse(JSON.stringify(item.data));
          timeSigBeatsInput.value = score.timeSignature.beats;
          timeSigBeatTypeSelect.value = score.timeSignature.beatType;
          bpmInput.value = score.bpm;
          renderScore();
          moveCursorTo(0, 0);
          alert(`Score "${item.name}" loaded into editor.`);
        });
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = "Delete";
        deleteBtn.className = "delete-btn";
        deleteBtn.addEventListener('click', () => {
          if (confirm(`Delete score "${item.name}" from library?`)) {
            scoreLibrary.splice(index, 1);
            updateLibraryList();
          }
        });
        li.appendChild(loadBtn);
        li.appendChild(deleteBtn);
        libraryList.appendChild(li);
      });
    }

    // Toggle Score Library panel
    toggleLibraryBtn.addEventListener('click', () => {
      if (libraryPanel.style.display === "block") {
        libraryPanel.style.display = "none";
        toggleLibraryBtn.textContent = "Show Score Library";
      } else {
        libraryPanel.style.display = "block";
        toggleLibraryBtn.textContent = "Hide Score Library";
      }
    });

    closeLibraryBtn.addEventListener('click', () => {
      libraryPanel.style.display = "none";
      toggleLibraryBtn.textContent = "Show Score Library";
    });

    // Playback
    playBtn.addEventListener('click', () => {
      initAudio();
      if (!audioCtx) return;
      console.log("Starting playback...");
      let currentTime = audioCtx.currentTime + 0.1;
      const secondsPerBeat = 60.0 / score.bpm;
      const beatValue = getBeatValue(score.timeSignature.beatType);
      document.querySelectorAll('.playing').forEach(el => el.classList.remove('playing'));
      score.measures.forEach((measure) => {
        measure.notes.forEach((note) => {
          const noteElement = document.getElementById(note.id);
          const noteStartTime = currentTime;
          let durationInBeats = note.durationBase * beatValue;
          if (note.dotted) durationInBeats *= 1.5;
          if (note.tieCount > 0) durationInBeats += note.durationBase * note.tieCount * beatValue;
          const durationSeconds = durationInBeats * secondsPerBeat;
          if (note.type === 'note') playTone(note.pitch, note.octave, durationSeconds, noteStartTime);
          if (noteElement) {
            const delay = Math.max(0, (noteStartTime - audioCtx.currentTime) * 1000);
            setTimeout(() => {
              document.querySelectorAll('.playing').forEach(el => el.classList.remove('playing'));
              noteElement.classList.add('playing');
              noteElement.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }, delay);
          }
          currentTime += durationSeconds;
        });
      });
      setTimeout(() => {
        document.querySelectorAll('.playing').forEach(el => el.classList.remove('playing'));
        console.log("Playback finished.");
      }, Math.max(0, (currentTime - audioCtx.currentTime) * 1000));
    });

    const additionalStyle = document.createElement('style');
    additionalStyle.innerHTML = `.note.playing, .rest.playing { background-color: yellow !important; }`;
    document.head.appendChild(additionalStyle);

    // Initialize score
    function initializeEmptyScore() {
      console.log("Initializing new empty score.");
      score = { timeSignature: { beats: 4, beatType: 4 }, bpm: 120, measures: [] };
      addMeasure();
      moveCursorTo(0, 0);
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeEmptyScore();
      renderScore();
    });

    editorArea.addEventListener('touchstart', (e) => {
      if (e.touches.length > 1) {}
    }, { passive: false });

    editorArea.addEventListener('scroll', () => {});
  </script>
</body>
</html>